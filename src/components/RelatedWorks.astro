---
// RelatedWorks.astro - ç”¨äºæ˜¾ç¤ºç›¸å…³ä½œå“å¹¶æå‡å†…éƒ¨é“¾æ¥
import { localdb as db } from "@/database/localdb";
import { table_works } from "@/database/schema_sqlite";
import { eq, ne, desc, sql } from "drizzle-orm";
import { Card, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";

export interface Props {
  workId: string | number;
  authorId: string | number;
  dynasty: string;
  limit?: number;
}

const { workId, authorId, dynasty, limit = 8 } = Astro.props;

// è·å–åŒä¸€ä½œè€…çš„å…¶ä»–ä½œå“
const sameAuthorWorks = await db
  .select()
  .from(table_works)
  .where(
    sql`${table_works.author_id} = ${authorId} AND ${table_works.id} != ${workId}`
  )
  .orderBy(desc(table_works.show_order))
  .limit(limit / 2);

// è·å–åŒä¸€æœä»£çš„çƒ­é—¨ä½œå“
const sameDynastyWorks = await db
  .select()
  .from(table_works)
  .where(
    sql`${table_works.dynasty} = ${dynasty} AND ${table_works.author_id} != ${authorId} AND ${table_works.id} != ${workId}`
  )
  .orderBy(desc(table_works.show_order))
  .limit(limit / 2);

// åˆå¹¶ä½œå“åˆ—è¡¨
const relatedWorks = [...sameAuthorWorks, ...sameDynastyWorks];
---

<div class="mt-10">
  <h3 class="text-xl font-semibold mb-4">ç›¸å…³ä½œå“æ¨è</h3>
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
    {
      relatedWorks.map((work) => (
        <a
          href={`/works/${work.id}`}
          class="animated-underline no-underline hover:text-primary"
          title={`${work.title} - ${work.author}`}
        >
          <Card className="hover:bg-gray-100 dark:hover:bg-gray-800 transition duration-150 ease-in-out h-full">
            <CardHeader>
              <CardTitle className="text-sm line-clamp-1">
                {work.title}
                {work.quotes_count >= 2 && ` ğŸ”¥`}
              </CardTitle>
              <CardDescription className="pt-2 text-sm line-clamp-1">
                {work.dynasty} - {work.author}
              </CardDescription>
            </CardHeader>
          </Card>
        </a>
      ))
    }
  </div>
</div> 