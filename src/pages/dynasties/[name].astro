---
import Base from "@/layouts/Base.astro";
import config from "@/config/config.json";
import PageHeader from "@/partials/PageHeader.astro";
import { localdb as db } from "@/database/localdb";
import {
  table_dynasties,
  table_works,
  table_authors,
} from "@/database/schema_sqlite";
import { desc, eq, lt, gte, ne } from "drizzle-orm";
import { Button } from "@/components/ui/button";
import SubTitle from "@/partials/SubTitle.astro";
import StructuredData from "@/components/StructuredData.astro";
import {
  Card,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";

export const prerender = true;

export async function getStaticPaths() {
  const list = await db.select().from(table_dynasties);
  return list.map((item) => {
    return {
      params: { name: item.name },
    };
  });
}

const { name } = Astro.params;

const dynasty = (
  await db.select().from(table_dynasties).where(eq(table_dynasties.name, name))
)[0];

const authors = await db
  .select()
  .from(table_authors)
  .where(eq(table_authors.dynasty, dynasty.name))
  .orderBy(desc(table_authors.views_count));

const works = await db
  .select()
  .from(table_works)
  .where(eq(table_works.dynasty, dynasty.name))
  .orderBy(desc(table_works.show_order));

// ä¼˜åŒ–SEOå…ƒæ•°æ® - ç¡®ä¿æ ‡é¢˜åœ¨40-60å­—ç¬¦ä¹‹é—´
const title = dynasty.name;
const meta_title = `${dynasty.name}è¯—è¯ç²¾é€‰ - ${authors.length}ä½è¯—äºº${works.length}éƒ¨ç»å…¸ä½œå“åˆé›† | ${config.site.title}`;
// ä¼˜åŒ–æè¿°ï¼Œæ§åˆ¶åœ¨140-160å­—ç¬¦ä¹‹é—´
const description = dynasty.intro 
  ? `${dynasty.name}è¯—è¯ç²¾é€‰ï¼Œæ”¶å½•${authors.length}ä½è¯—äºº(å¦‚${authors[0]?.name || ''}ã€${authors[1]?.name || ''})å…±${works.length}éƒ¨ç»å…¸ä½œå“ã€‚æ¢ç´¢${dynasty.name}æ–‡å­¦é£æ ¼ã€ä»£è¡¨ä½œå®¶åŠå†å²èƒŒæ™¯ï¼Œæ„Ÿå—è¿™ä¸€æ—¶æœŸä¸­å›½å¤å…¸æ–‡å­¦çš„ç‹¬ç‰¹é­…åŠ›ã€‚` 
  : `${dynasty.name}è¯—è¯ç²¾é€‰ï¼Œæ”¶å½•${authors.length}ä½è‘—åè¯—äººå…±${works.length}éƒ¨ç»å…¸ä½œå“ï¼ŒåŒ…æ‹¬${works[0]?.title || ''}ã€${works[1]?.title || ''}ç­‰åç¯‡ã€‚æ¢ç´¢${dynasty.name}è¯—è¯çš„è‰ºæœ¯ç‰¹è‰²ã€æ–‡å­¦æˆå°±ä¸å†å²ä»·å€¼ã€‚`;
const canonical = config.site.base_url + `/dynasties/${name}`;

// å‡†å¤‡ç»“æ„åŒ–æ•°æ®
const articleData = {
  title: `${dynasty.name}è¯—è¯ç²¾é€‰`,
  description: description,
  author: config.metadata.meta_author,
  siteName: config.site.title,
  siteUrl: config.site.base_url,
  url: canonical
};
---

<Base meta_title={meta_title} description={description} canonical={canonical}>
  <!-- æ·»åŠ ç»“æ„åŒ–æ•°æ® -->
  <StructuredData type="Article" data={articleData} />
  
  <!-- ç”Ÿæˆé¢åŒ…å±‘å¯¼èˆªç»“æ„åŒ–æ•°æ® -->
  <StructuredData 
    type="BreadcrumbList" 
    data={[
      { position: 1, name: "é¦–é¡µ", item: config.site.base_url },
      { position: 2, name: dynasty.name, item: canonical }
    ]} 
  />
  
  <PageHeader title={title} />
  <section class="section px-4 pt-0 pb-0 mb-14 mx-auto">
    <div class="container">
      <div class="justify-center mt-10 flex flex-row gap-6">
        <Button variant="default" size="sm" className="">
          <a href="#authors">
            è©©äºº({authors.length})
          </a>
        </Button>

        <Button variant="outline" size="sm" className="">
          <a href="#works">
            ä½œå“({works.length})
          </a>
        </Button>
      </div>

      <!-- æœä»£ç°¡ä»‹ -->
      <SubTitle title="ç°¡ä»‹" description="" />
      <span class="">{dynasty.intro}</span>

      <!-- è©©äººåˆ—è¡¨ -->
      <SubTitle id="authors" title="è©©äºº" description={`(${authors.length})`} />
      <div
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"
      >
        {
          authors.map((author, index) => (
            <div>
              <a
                href={`/authors/${author.id}`}
                title={author.name}
                class="text-sm cursor-pointer"
              >
                <Card className="hover:bg-gray-100 dark:hover:bg-gray-800 transition duration-150 ease-in-out">
                  <CardHeader>
                    <CardTitle className="text-sm line-clamp-1">
                      {author.name}
                      {author.quotes_count >= 2 && ` ğŸ”¥`}
                    </CardTitle>
                    <CardDescription className="pt-2 text-sm line-clamp-1">
                      {author.intro === null ||
                      author.intro === "" ||
                      author.intro === "undefined" ||
                      author.intro === "NONE" ||
                      author.intro === "None"
                        ? "æš«ç„¡ç°¡ä»‹"
                        : author.intro}
                    </CardDescription>
                  </CardHeader>
                </Card>
              </a>
            </div>
          ))
        }
      </div>

      <!-- ä½œå“åˆ—è¡¨ -->
      <SubTitle id="works" title="ä½œå“" description={`(${works.length})`} />
      <div
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"
      >
        {
          works.map((work, index) => (
            <div>
              <a data-astro-reload
                href={`/works/${work.id}`}
                title={work.title}
                class="text-sm cursor-pointer"
              >
                <Card className="hover:bg-gray-100 dark:hover:bg-gray-800 transition duration-150 ease-in-out">
                  <CardHeader>
                    <CardTitle className="text-sm line-clamp-1">
                      {work.title}
                      {work.quotes_count >= 2 && ` ğŸ”¥`}
                    </CardTitle>
                    <CardDescription className="pt-2 text-sm line-clamp-1">
                      {work.dynasty} - {work.author}
                    </CardDescription>
                  </CardHeader>
                </Card>
              </a>
            </div>
          ))
        }
      </div>
    </div>
  </section>
</Base>
